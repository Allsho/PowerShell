# Configuration
$ServerName = "YourServerName"
$Database = "YourDatabase"
$FilePath = "C:\path\to\your\anthemfile.txt"
$Delimiter = "|"  # Adjust based on your file's delimiter
$DataMappingTable = "dbo.DataMapping"
$TargetTable = "Anthem.MemberShip"

# Step 1: Fetch Column Mappings using sqlcmd
$mappingQuery = "SELECT SourceColumnIndex, TargetColumnName FROM $DataMappingTable WHERE TargetTable = '$TargetTable'"
$MappingResults = & sqlcmd -S $ServerName -d $Database -Q $mappingQuery -W -s"," | ForEach-Object {
    $parts = $_ -split ","
    [PSCustomObject]@{
        SourceColumnIndex = $parts[0]
        TargetColumnName = $parts[1]
    }
}

if (-not $MappingResults) {
    Write-Output "Failed to retrieve column mappings. Exiting script."
    exit
}

# Step 2: Process the Anthem file
if (Test-Path -Path $FilePath) {
    $lines = Get-Content -Path $FilePath
    $sqlStatements = @()

    # Skip header and process each line
    foreach ($line in $lines[1..$lines.Length]) {
        $columns = $line -split $Delimiter
        $columnNames = @()
        $values = @()

        foreach ($mapping in $MappingResults) {
            $sourceIndex = [int]$mapping.SourceColumnIndex
            $targetColumn = $mapping.TargetColumnName

            # Ensure the source index is within the bounds of the columns array
            if ($sourceIndex -lt $columns.Length) {
                $value = $columns[$sourceIndex] -replace "'", "''"  # Escape single quotes
                $columnNames += $targetColumn
                $values += "'$value'"
            }
            else {
                Write-Output "Warning: Source index $sourceIndex out of bounds for line: $line"
            }
        }

        # Construct SQL Insert Statement
        $sqlStatement = "INSERT INTO $TargetTable (" + ($columnNames -join ", ") + ") VALUES (" + ($values -join ", ") + ");"
        $sqlStatements += $sqlStatement
    }

    # Step 3: Write SQL Statements to a Temporary SQL File
    $tempSqlFile = "$env:TEMP\InsertStatements.sql"
    $sqlStatements -join "`n" | Set-Content -Path $tempSqlFile -Force

    # Step 4: Execute the SQL File using sqlcmd
    try {
        & sqlcmd -S $ServerName -d $Database -i $tempSqlFile
        Write-Output "Data load completed."
    }
    catch {
        Write-Output "Error inserting data: $($_.Exception.Message)"
    }
    
    # Clean up
    Remove-Item -Path $tempSqlFile -Force
} else {
    Write-Output "File not found at path: $FilePath"
}
